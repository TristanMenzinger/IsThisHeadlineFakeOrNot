<html>

<head>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.4.1/css/bootstrap.min.css" integrity="sha384-Vkoo8x4CGsO3+Hhxv8T/Q5PaXtkKtu6ug5TOeNV6gBiFeWPGFN9MuhOf23Q9Ifjh" crossorigin="anonymous">
    <link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.8.1/css/all.css" integrity="sha384-50oBUHEmvpQ+1lW4y57PTFmhCaXp0ML5d60M1M7uH2+nqUivzIebhndOJK28anvf" crossorigin="anonymous">
</head>
<style>
    html, body {
        margin: 0px;
        padding: 0px;
        width: 100%;
        height: 100%;
        overflow: hidden;
    }

    .swipe-card {
        position: absolute;

        margin: auto;
        left: 0;
        right: 0;

        height: calc(100% - 3em);
        width: 80%;
        max-width: 400px;

        will-change: transform;
    }
    .swipe-card.smooth {
        transition: 1s ease-in-out;
    }
    .swipe-card.hide {
        display: none;
    }

    .swipe-card.smooth > .overlay {
        transition: 0.5s ease-in-out;
        will-change: transform;
    }
    .swipe-card.overlay {
        display: flex;
        justify-content: center;

        font-size: 50pt;
        font-weight: 600;
        color: white;

        opacity: 0;

        height: 100%;
        width: 100%;
        margin-top: -20px;
    }
    .swipe-card.overlay span {
        align-self: center;
    }
    .swipe-card.overlay.overlay-left {
        background-color: rgb(200, 0, 0);
    }
    .swipe-card.overlay.overlay-right {
        background-color: rgb(109, 168, 50);
    }

    body {
        display: flex;
        justify-content: center;
    }

    #container-wrapper {
        display: none; /* flex */
        flex-direction: column;
        align-self: center;
        overflow: hidden;
        height: 100%;
        width: 100vw;
    }
    .rel-max-wrapper {
        position: relative;
        height: 100%;
        width: 100%;
    }

    /* Styling */
    .headline {
        flex-grow: 0;
        flex-shrink: 0;
        flex-basis: 40%;
        padding: 20px;
        overflow: none;
    }
    .swipe-card .card-body {
        display: flex;
        flex-direction: column;
        padding: 0px;
    }
    .card-text {
        padding: 15px;

        max-height: 90%;
        overflow: hidden;

        font-size: 20pt;
        font-family: Helvetica, Roboto, Arial;
        font-weight: 700;
    }

    .card-info {
        display: flex;
    }
    .card-count {
        margin-left: auto;
        color: darkgray;
    }  

    .card-difficulty {
        margin-left: 5px;
    }

    .card-difficulty {
    }

    #difficulty {
        position: absolute;

        width: 100%;
        height: 100%;

        display: none; /* flex */
        flex-direction: column;

        align-items: center;
    }

    #difficulty a {
        margin-bottom: 1.5rem;
        width: 100px;
    }
    #difficulty .btn-outline-secondary {
        border: none;
    }

    #info-done {
        position: absolute;

        width: 100%;
        height: 100%;

        display: none; /* flex */
        flex-direction: column;

        align-items: center;
        justify-content: center;
    }
    #info-done > span {
        display: flex;
        align-items: baseline;
        flex-direction: row;
    }
    #info-done > span > * {
        margin-right: 5px;
    }

    #container-title {
        align-self: center;
        padding: 3em;
        padding-bottom: 2em;

        width: 100%;
        max-width: 500px;
    }
    #container-title h1 {
        font-weight: 700;
    }
    #container-title > *:not(:first-child) {
        margin-top: -15px;
    }
    #container-title span.red, #question span.red {
        text-decoration: underline;
        text-decoration-color: rgb(200, 0, 0);
    }
    #container-title span.green, #question span.green {
        text-decoration: underline;
        text-decoration-color: rgb(109, 168, 50);
    }
    #container-title .instructions {
        font-size: 10pt;
        color: darkgray;
    }

    #difficulty #difficulty-picker {
        display: flex;
        flex-direction: column;
        /*margin-top: auto;*/
        /*margin-bottom: auto;*/


        justify-content: center;
        align-items: center;

        height: calc(100% - 3em - 10em);
        width: 80%;
        max-width: 400px;
    }

    #info-done-results {
        display: flex;
        width: 100%;
        padding: 3em;
        flex-direction: column;
    }
    #info-done-results .info-card {
        width: 100%;
        margin-bottom: 0.5em;
    }
    .red {
        color: rgb(200, 0, 0);;
    }
    .green {
        color: rgb(109, 168, 50);
    }
    .info-card i {
        position: absolute;
        right: 10px;
        top: 10px;
        color: darkgray;
    }
    .info-card .score {
        font-size: 10pt;
    }
    .info-card .title {
        font-weight: 700;
    }

</style>

<body>
    <div id="difficulty">
        <div id="container-title">
            <h4>Is this Headline</h4>
            <h1><span class="red">fake</span> or <span class="green">not</span>?</h1>
        </div>
        <div id="difficulty-picker">
            <a role="button" href="?difficulty=Easy" class="btn btn-outline-success">
                Easy
            </a>
            <a role="button" href="?difficulty=Medium" class="btn btn-outline-warning">
                Medium
            </a>
            <a role="button" href="?difficulty=Hard" class="btn btn-outline-danger">
                Hard
            </a>
            <a role="button" href="?difficulty=Hard" class="btn btn-outline-secondary">
                Mixed
            </a>
        </div>
    </div>
    <div id="info-done">
        <h1>All done.</h1>
        <span>
            <h6>You got</h6>
            <h5>3 / 10</h5>
            <h6>right.</h6>
        </span>
        <span>
            <h5><a href="javascript:history.go(0)">Play again</a></h5>
            <h6>or</h6>
            <h5><a href="?">Change difficulty</a></h5>
        </span>
        <div id="info-done-results">
<!--             <div class="card info-card">
                <div class="card-body">
                    <i class="fas fa-check"></i>
                    <span class="title">Lisa Joy Joins Chris Pratt In 'Raising Hope'</span>
                    <span class="score"><span class="red">is fake</span> and you <span class="red">said it was fake</span>.</span>
                </div>
            </div>
            <div class="card info-card">
                <div class="card-body">
                    <i class="fas fa-times"></i>
                    <span class="title">Kata Ost: Direct All Children To Holiday Book Club</span>
                    <span class="score"><span class="green">is real</span> and you <span class="red">said it was fake</span>.</span>
                </div>
            </div> -->
            <!--             <div class="card">
                <div class="card-body">
                    <span>Laura Bicker, Former DNC Chair, Discusses Getting Back to Work After a Breakup</span>
                    <span class="badge badge-success">Right</span>
                </div>
            </div>
            <div class="card">
                <div class="card-body">
                    <span>The Easiest Slut-shaming Tax Ways To Get Rid Of The Smugness</span>
                    <span class="badge badge-success">Right</span>
                </div>
            </div> -->
        </div>
    </div>
    <div id="container-wrapper">
        <div id="container-title">
            <h4>Is this Headline</h4>
            <h1><span class="red">fake</span> or <span class="green">not</span>?</h1>
            <span class="instructions">Swipe right if you think it's real, left if fake.</span>
        </div>
        <div id="container-headlines" class="rel-max-wrapper">
        </div>
    </div>
    <script type="text/javascript">
    class Card {
        constructor(title, count, settings) {
            this.title = title;
            this.count = count;

            this._create_div();

            this.overlay_left = this.div.querySelector(".overlay-left");
            this.overlay_right = this.div.querySelector(".overlay-right");

            settings = settings ? settings : {};
            this.threshold_go = settings["threshold_go"] ? settings["threshold_go"] : 0.4;
            this.overlay_multiplier = settings["overlay_multiplier"] ? settings["overlay_multiplier"] : 2;
            this.fade_multiplier = settings["fade_multiplier"] ? settings["fade_multiplier"] : 0.5;

            this.initial_rotation = (Math.random() - 0.5) * 5;
            this.initial_x_offset = (Math.random() - 0.5) * 5;
            this.initial_y_offset = (Math.random() - 0.5) * 5;

            // Hide out of view by default
            this.div.style.transform = `translateX(${screen.width+Math.random()*200}px) translateY(${(Math.random()-0.5)*screen.height/3}px) translateZ(1000px) rotate(${(Math.random()-0.5)*20}deg) rotateX(40deg) rotateY(30deg)`;

            this.gone = false;;

        }

        _create_div() {
            let template = `
                <div class="card swipe-card headline">
                    <div class="swipe-card overlay overlay-left"><span>Fake</span></div>
                    <div class="swipe-card overlay overlay-right"><span>Real</span></div>
                    <div class="card-body">
                        <div class="card-info">
                            <p class="card-count">${this.count}/10</p>
                            <p class="card-difficulty"><span style="color: ${difficulty === "Easy" ? '#28a745' : difficulty === "Medium" ? '#ffc107' : '#dc3545'}">${difficulty}</span></p>
                        </div>
                        <!-- <h5 class="card-title">Special title treatment</h5> -->
                        <p class="card-text">${this.title}</p>
                    </div>
                </div>`;
            this.div = div_from_template(template);
        }

        show() {
            this.div.classList.add("smooth");
            this.div.style.transform = `translateX(${this.initial_x_offset}px) translateY(${this.initial_y_offset}px) rotate(${this.initial_rotation}deg)`;

        }

        activate() {

            this.div.ontouchstart = (event) => {
                this.div.classList.remove("smooth");
                this.start_x = event.touches[0].clientX;
                this.start_y = event.touches[0].clientY;
                this.width = this.div.getBoundingClientRect().width;
            }
            this.div.ontouchmove = (event) => {
                const percentage_progress = (event.touches[0].clientX - this.start_x) / this.width;
                this.set_progress(percentage_progress);
            }
            this.div.ontouchend = (event) => {
                const percentage_progress = (event.changedTouches[0].clientX - this.start_x) / this.width;
                if (Math.abs(percentage_progress) > this.threshold_go) {
                    this.go(percentage_progress / Math.abs(percentage_progress));
                } else {
                    this.comeback();
                }
            }

            let drag = false;
            this.div.onmousedown = (event) => {
                drag = true;
                this.div.classList.remove("smooth");
                this.start_x = event.clientX;
                this.start_y = event.clientY;
                this.width = this.div.getBoundingClientRect().width;
            }
            this.div.onmousemove = (event) => {
                if (drag) {
                    const percentage_progress = (event.clientX - this.start_x) / this.width;
                    this.set_progress(percentage_progress);
                }
            }
            this.div.onmouseup = (event) => {
                drag = false;

                const percentage_progress = (event.clientX - this.start_x) / this.width;
                if (Math.abs(percentage_progress) > this.threshold_go) {
                    this.go(percentage_progress / Math.abs(percentage_progress));
                } else {
                    this.comeback();
                }
            }
        }

        deactivate() {
            this.div.ontouchstart = () => {}
            this.div.ontouchmove = () => {}
            this.div.ontouchend = () => {}
        }


        set_progress(percentage_progress) {
            if (!this.gone) {
                const x_transform = this.initial_x_offset + percentage_progress * this.width;
                const rotation = this.initial_rotation + 10 * percentage_progress;

                this.div.style.opacity = 1 - sigmoid((Math.abs(this.fade_multiplier * percentage_progress) - 0.75) * 10);
                this.div.style.transform = `translateX(${x_transform}px) translateY(${this.initial_y_offset}px) rotate(${rotation}deg)`;

                const opacity = sigmoid((Math.abs(this.overlay_multiplier * percentage_progress) - 0.5) * 5);
                console.log(opacity);
                if (percentage_progress < 0) {
                    this.overlay_left.style.opacity = opacity;
                } else {
                    this.overlay_right.style.opacity = opacity;
                }
            }
        }

        comeback() {
            this.div.classList.add("smooth");

            this.overlay_left.style.opacity = 0;
            this.overlay_right.style.opacity = 0;

            this.div.style.opacity = 1;
            this.div.style.transform = `translateX(${this.initial_x_offset}px) translateY(${this.initial_y_offset}px) rotate(${this.initial_rotation}deg)`;
        }

        go(direction) {
            if (!this.gone) {
                this.div.classList.add("smooth");
                this.set_progress(direction * 2);
                setTimeout(() => {
                    this.div.classList.add("hide");
                }, 1000);
                if (this.stack) {
                    this.stack.next();
                }

                this.gone = true;
            }
        }
    }

    class Stack {
        constructor(cards) {
            this.cards = cards;
            for (let card of cards) {
                card.stack = this;
            }

            this.index = this.cards.length - 1;
            this.current = this.cards[this.index];
            this.current.activate();
        }

        async show_all() {
            for (let card of this.cards) {
                await sleep(75 + Math.random() * 50);
                card.show()
            }
        }

        next() {
            this.index = this.index - 1;
            if (this.index >= 0) {
                this.current = this.cards[this.index];
                console.log(this.index);
                this.current.activate();
            } else {
                setTimeout(() => {
                    document.getElementById('container-wrapper').style.zIndex = '-100';
                }, 300);
            }
        }
    }

    let div_from_template = (filled_template_string) => {
        let wrapper = document.createElement("div");
        wrapper.innerHTML = filled_template_string;
        return wrapper.firstElementChild;
    }

    function sigmoid(t) {
        return 1 / (1 + Math.exp(-t));
    }

    function sleep(ms) {
        return new Promise(resolve => setTimeout(resolve, ms));
    }

    function show_headlines(headlines) {

        let cards = []
        for (let i = 0; i < 10; i++) {
            cards.push(new Card(headlines[i], 10 - i));
        }

        container = document.querySelector("#container-headlines");
        for (let card of cards) {
            container.appendChild(card.div);
        }
        let stack = new Stack(cards);

        document.getElementById('container-wrapper').style.zIndex = '100';
        stack.show_all();
        document.getElementById('container-wrapper').style.display = 'flex';

        setTimeout(function() {
            document.getElementById('info-done').style.display = 'flex';
        }, 3000);
    }

    const queryParams = new URLSearchParams(window.location.search);
    const difficulty = queryParams.get('difficulty');

    if (difficulty) {
        const xhttp = new XMLHttpRequest();
        xhttp.onreadystatechange = function() {
            if (this.readyState == 4 && this.status == 200) {
                const headlines = JSON.parse(this.responseText);
                show_headlines(headlines);
            }
        };
        xhttp.open("POST", "https://get-headlines.fake-or-not.workers.dev");
        xhttp.send();
    } else {
        document.getElementById('difficulty').style.display = 'flex';
    }
    </script>
</body>

</html>